<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="SweetShopMa.Views.MainPage"
             Title="ðŸ¬ Sweet Shop">

    <Grid RowDefinitions="Auto,Auto,*" ColumnDefinitions="*,350" Padding="20" RowSpacing="15" ColumnSpacing="20">

        <!-- Header -->
        <Frame Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" Padding="20" 
               BackgroundColor="#32b8c6" CornerRadius="8" BorderColor="#32b8c6">
            <Grid ColumnDefinitions="*,Auto">
                <StackLayout Grid.Column="0" Spacing="5">
                    <Label Text="ðŸ¬ Sweet Shop" FontSize="28" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center"/>
                    <Label Text="Your favorite sweets and treats" FontSize="14" TextColor="White" HorizontalTextAlignment="Center"/>
                    <Label Text="{Binding CurrentUserName, StringFormat='Logged in as: {0}'}" FontSize="12" TextColor="White" HorizontalTextAlignment="Center" Opacity="0.9"/>
                </StackLayout>
                <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="10" VerticalOptions="Center">
                    <Button Text="ðŸ” Login" BackgroundColor="#1d7480" TextColor="White" Padding="10,8" CornerRadius="6" FontSize="12"
                            Command="{Binding LoginCommand}">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding IsAuthenticated}" Value="True">
                                <Setter Property="IsVisible" Value="False"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <Button Text="ðŸšª Logout" BackgroundColor="#c00000" TextColor="White" Padding="10,8" CornerRadius="6" FontSize="12"
                            Command="{Binding LogoutCommand}">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding IsAuthenticated}" Value="False">
                                <Setter Property="IsVisible" Value="False"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                </StackLayout>
            </Grid>
        </Frame>

        <!-- Quick Input Panel for Cashier (Keyboard-Friendly) -->
        <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Padding="15"
                BackgroundColor="#f5f5f5" Stroke="#ddd" StrokeThickness="2">
          <Border.StrokeShape>
            <RoundRectangle CornerRadius="8" />
          </Border.StrokeShape>
            <Grid ColumnSpacing="10" RowSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
              
              <!-- Product Search -->
              <StackLayout Grid.Row="0" Grid.Column="0" Spacing="5">
                  <Label Text="ðŸ” Scan/Enter Barcode or ID" FontSize="12" FontAttributes="Bold" TextColor="#333"/>
                  <Entry Text="{Binding QuickSearchText}" 
                         Placeholder="Scan barcode or enter ID (e.g., 1001, 1008)..." 
                         FontSize="14"
                         Keyboard="Default" 
                         BackgroundColor="White"
                         ReturnType="Next"
                         Completed="OnBarcodeEntryCompleted"
                         x:Name="ProductSearchEntry"/>
                </StackLayout>

                <!-- Quantity Input -->
                <StackLayout Grid.Row="0" Grid.Column="1" Spacing="5" WidthRequest="120">
                    <Label FontSize="12" FontAttributes="Bold" TextColor="#333">
                        <Label.Text>
                            <Binding Path="SelectedQuickProduct.UnitLabel" StringFormat="ðŸ“¦ Qty ({0})" TargetNullValue="ðŸ“¦ Quantity"/>
                        </Label.Text>
                    </Label>
                    <Entry Text="{Binding QuickQuantityText}" 
                           Placeholder="" 
                           FontSize="14" 
                           BackgroundColor="White"
                           Keyboard="Numeric"
                           ReturnType="Done"
                           Completed="OnQuantityEntryCompleted"
                           x:Name="QuantityEntry"/>
                </StackLayout>

                <!-- Quick Add Button -->
                <StackLayout Grid.Row="0" Grid.Column="2" Spacing="5" VerticalOptions="End">
                    <Label Text=" " FontSize="12"/> <!-- Spacer for alignment -->
                    <Button Text="âž• Add" 
                            BackgroundColor="#32b8c6" 
                            TextColor="White" 
                            Padding="20,12" 
                            CornerRadius="6" 
                            FontSize="14" 
                            FontAttributes="Bold"
                            Command="{Binding QuickAddCommand}"
                            x:Name="QuickAddButton"/>
                </StackLayout>

                <!-- Notification Message (subtle, non-blocking) -->
                <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3"
                       Text="{Binding NotificationMessage}"
                       FontSize="12"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       Padding="10,5"
                       Margin="0,5,0,0"
                       IsVisible="{Binding HasNotification}">
                    <Label.Triggers>
                        <DataTrigger TargetType="Label" Binding="{Binding IsErrorNotification}" Value="True">
                            <Setter Property="TextColor" Value="#c00000"/>
                            <Setter Property="BackgroundColor" Value="#fff3cd"/>
                        </DataTrigger>
                        <DataTrigger TargetType="Label" Binding="{Binding IsErrorNotification}" Value="False">
                            <Setter Property="TextColor" Value="#28a745"/>
                            <Setter Property="BackgroundColor" Value="#d4edda"/>
                        </DataTrigger>
                    </Label.Triggers>
                </Label>

                <!-- Selected Product Display -->
                <StackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" 
                             Orientation="Horizontal" 
                             Spacing="10" 
                             Padding="10,5" 
                             BackgroundColor="White"
                             IsVisible="{Binding HasSelectedProduct}">
                    <Label Text="{Binding SelectedQuickProduct.Emoji}" FontSize="20" VerticalOptions="Center"/>
                    <Label FontSize="13" FontAttributes="Bold" VerticalOptions="Center">
                        <Label.Text>
                            <MultiBinding StringFormat='{}{0} - ${1:F2}/{2}'>
                                <Binding Path="SelectedQuickProduct.Name"/>
                                <Binding Path="SelectedQuickProduct.Price"/>
                                <Binding Path="SelectedQuickProduct.UnitLabel"/>
                            </MultiBinding>
                        </Label.Text>
                    </Label>
                    <Label Text="â€¢" FontSize="13" TextColor="#999" VerticalOptions="Center"/>
                    <Label FontSize="13" TextColor="#666" VerticalOptions="Center">
                        <Label.Text>
                            <MultiBinding StringFormat='Stock: {0} {1}'>
                                <Binding Path="SelectedQuickProduct.Stock"/>
                                <Binding Path="SelectedQuickProduct.UnitLabel"/>
                            </MultiBinding>
                        </Label.Text>
                    </Label>
                    <Label Text="â€¢" FontSize="13" TextColor="#999" VerticalOptions="Center"/>
                    <Label FontSize="12" TextColor="#888" VerticalOptions="Center">
                        <Label.Text>
                            <Binding Path="SelectedQuickProduct.Barcode" StringFormat="Barcode: {0}"/>
                        </Label.Text>
                    </Label>
                </StackLayout>
            </Grid>
        </Border>

        <!-- Products Grid - Compact buttons for cashier -->
        <ScrollView Grid.Row="2" Grid.Column="0">
            <CollectionView ItemsSource="{Binding Products}" SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="4" VerticalItemSpacing="8" HorizontalItemSpacing="8"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeThickness="1" Stroke="#e0e0e0" Padding="8" BackgroundColor="White">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6"/>
                            </Border.StrokeShape>
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="4">
                                <!-- Emoji -->
                                <Label Grid.Row="0" Text="{Binding Emoji}" FontSize="32" HorizontalTextAlignment="Center" VerticalOptions="Center"/>
                                
                                <!-- Name -->
                                <Label Grid.Row="1" Text="{Binding Name}" FontSize="11" FontAttributes="Bold" HorizontalTextAlignment="Center" 
                                       LineBreakMode="TailTruncation" MaxLines="2"/>
                                
                                <!-- Price -->
                                <Label Grid.Row="2" FontSize="12" FontAttributes="Bold" 
                                       TextColor="#1d7480" HorizontalTextAlignment="Center">
                                    <Label.Text>
                                        <MultiBinding StringFormat='{}${0:F2}/{1}'>
                                            <Binding Path="Price"/>
                                            <Binding Path="UnitLabel"/>
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                                
                                <!-- Stock -->
                                <Label Grid.Row="3" FontSize="9" TextColor="#666" HorizontalTextAlignment="Center">
                                    <Label.Text>
                                        <MultiBinding StringFormat="Stock: {0}">
                                            <Binding Path="Stock"/>
                                            <Binding Path="UnitLabel"/>
                                        </MultiBinding>
                                    </Label.Text>
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding Stock}" Value="0">
                                            <Setter Property="Text" Value="Out"/>
                                            <Setter Property="TextColor" Value="#c00000"/>
                                            <Setter Property="FontAttributes" Value="Bold"/>
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                                
                                <!-- Quantity controls: three decrements, quantity display, three increments -->
                                <Grid Grid.Row="4" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="4" Margin="0,4,0,0">
                                    <!-- Left: decrements -->
                                    <StackLayout Grid.Column="0" Orientation="Vertical" Spacing="4" VerticalOptions="Center">
                                        <Button Text="-250g" Padding="2,4" CornerRadius="3" FontSize="10" BackgroundColor="#f0f0f0" TextColor="Black"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Decrease250Command}"
                                                CommandParameter="{Binding .}" />
                                        <Button Text="-100g" Padding="2,4" CornerRadius="3" FontSize="10" BackgroundColor="#f0f0f0" TextColor="Black"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Decrease100Command}"
                                                CommandParameter="{Binding .}" />
                                        <Button Text="-50g" Padding="2,4" CornerRadius="3" FontSize="10" BackgroundColor="#f0f0f0" TextColor="Black"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Decrease50Command}"
                                                CommandParameter="{Binding .}" />
                                    </StackLayout>

                                    <!-- Middle: quantity display -->
                                    <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="4" VerticalOptions="Center" HorizontalOptions="Center">
                                        <Label FontSize="11" FontAttributes="Bold" VerticalTextAlignment="Center" HorizontalTextAlignment="Center" MinimumWidthRequest="40">
                                            <Label.Text>
                                                <Binding Path="Quantity" StringFormat="{}{0:F2}"/>
                                            </Label.Text>
                                        </Label>
                                        <Label Text="{Binding UnitLabel}" FontSize="9" VerticalTextAlignment="Center" TextColor="#666"/>
                                    </StackLayout>

                                    <!-- Right: increments -->
                                    <StackLayout Grid.Column="2" Orientation="Vertical" Spacing="4" VerticalOptions="Center">
                                        <Button Text="+250g" Padding="2,4" CornerRadius="3" FontSize="10" BackgroundColor="#1d7480" TextColor="White"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Increase250Command}"
                                                CommandParameter="{Binding .}">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding Stock}" Value="0">
                                                    <Setter Property="IsEnabled" Value="False"/>
                                                    <Setter Property="BackgroundColor" Value="#999"/>
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>
                                        <Button Text="+100g" Padding="2,4" CornerRadius="3" FontSize="10" BackgroundColor="#1d7480" TextColor="White"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Increase100Command}"
                                                CommandParameter="{Binding .}">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding Stock}" Value="0">
                                                    <Setter Property="IsEnabled" Value="False"/>
                                                    <Setter Property="BackgroundColor" Value="#999"/>
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>
                                        <Button Text="+50g" Padding="2,4" CornerRadius="3" FontSize="10" BackgroundColor="#1d7480" TextColor="White"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Increase50Command}"
                                                CommandParameter="{Binding .}">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding Stock}" Value="0">
                                                    <Setter Property="IsEnabled" Value="False"/>
                                                    <Setter Property="BackgroundColor" Value="#999"/>
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>
                                    </StackLayout>
                                </Grid>
                                
                                <!-- Add to Cart Button -->
                                <Button Grid.Row="5" Text="Add" BackgroundColor="#32b8c6" TextColor="White" 
                                        CornerRadius="4" Padding="4,6" FontSize="10" FontAttributes="Bold" Margin="0,4,0,0"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.AddToCartCommand}"
                                        CommandParameter="{Binding .}">
                                    <Button.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding Stock}" Value="0">
                                            <Setter Property="Text" Value="Out"/>
                                            <Setter Property="BackgroundColor" Value="#999"/>
                                            <Setter Property="IsEnabled" Value="False"/>
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                                
                                <!-- Restock Button (Admin Only) - Small -->
                                <Button Grid.Row="6" Text="ðŸ“¦" BackgroundColor="#4CAF50" TextColor="White" 
                                        CornerRadius="4" Padding="2,4" FontSize="10" Margin="0,2,0,0"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RestockCommand}"
                                        CommandParameter="{Binding .}"
                                        IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsAdmin}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>

        <!-- Cart Sidebar -->
        <Frame Grid.Row="2" Grid.Column="1" Padding="16" CornerRadius="8" BorderColor="#e0e0e0">
            <StackLayout Spacing="12">
                <Label Text="ðŸ›’ Cart" FontSize="18" FontAttributes="Bold"/>

                <!-- Cart Items -->
                <CollectionView ItemsSource="{Binding CartItems}" SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <StackLayout Padding="10" Spacing="5" Margin="0">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label Text="{Binding Emoji}" FontSize="16" VerticalTextAlignment="Center"/>
                                    <Label Text="{Binding Name}" FontSize="14" VerticalOptions="Center" HorizontalOptions="FillAndExpand"/>
                                    <StackLayout Orientation="Horizontal" Spacing="2" VerticalOptions="Center">
                                        <Label FontSize="14" FontAttributes="Bold" VerticalOptions="Center">
                                            <Label.Text>
                                                <MultiBinding StringFormat="Ã—{0:F2} {1}">
                                                    <Binding Path="Quantity"/>
                                                    <Binding Path="UnitLabel"/>
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                    </StackLayout>
                                </StackLayout>
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label Text="{Binding ItemTotal, StringFormat='${0:F2}'}" FontSize="13" FontAttributes="Bold" HorizontalOptions="FillAndExpand"/>
                                    <Button Text="Remove" BackgroundColor="#c00000" TextColor="White" Padding="4,8" FontSize="12" CornerRadius="3"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveFromCartCommand}"
                                            CommandParameter="{Binding .}"/>
                                </StackLayout>
                            </StackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Total and Checkout -->
                <BoxView HeightRequest="1" Color="#ddd" Margin="0,12"/>
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <Label Text="Total:" FontSize="16" FontAttributes="Bold" VerticalOptions="Center"/>
                    <Label Text="{Binding Total, StringFormat='${0:F2}'}" FontSize="16" FontAttributes="Bold" TextColor="#1d7480" HorizontalOptions="EndAndExpand" VerticalOptions="Center"/>
                </StackLayout>
                <Button Text="Checkout" BackgroundColor="#32b8c6" TextColor="White" Padding="12" CornerRadius="6" FontAttributes="Bold"
                        IsEnabled="{Binding IsCheckoutEnabled}"
                        Command="{Binding CheckoutCommand}"/>
            </StackLayout>
        </Frame>
    </Grid>
</ContentPage>

